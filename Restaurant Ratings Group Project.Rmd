---
title: "Restaurant Ratings Group Project"
author: "Matt"
date: "January 16, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

We explore the effect that ratings have on small and medium-sized (i.e. non-chain) restaurants in major US cities (depending on the amount of data available, we may limit analysis this to NYC). We'd use open APIs provided by Foursquare (and potentially Yelp) to access data on both reviews and check-ins (which we'd consider to be a proxy for sales). We will first look at the data before we come up with one or more crisp research questions, but we're thinking about something along the lines of the following:
 
1.     Do significant (and secular) changes in ratings affect check-ins for established restaurants?
 
       The data that we are using from foursquare consists of check-ins over a given period of time for each restaurant.
       Preparation of a treatment group: This consists of restaurants that have undergone a significant change in ratings (for e.g. a change >1) over a period of time.
        o   We run logistic regressions on this data in order to determine the predictive power of various restaurant features on the outcome of interest namely changes in check-ins.
        o   Using features that we identify as sufficiently predictive, we would conduct a propensity score matching ideally using “nearest neighbor matching”. This control group consists of restaurants that have not undergone a significant change in rating but are as similar as possible to the restaurants in the treatment group.
              ·  We would use this matched control group to ascertain the impact of the change in rating to the restaurants in the treatment group.
 
2.     To what extent does an increase (or decrease) in ratings explain the variance in check-ins? 
        ·      Perform a regression analysis (using ordered logistic regression) to determine the correlation between ratings and check-ins
 
3. For businesses with the same rating, how important is the distribution of ratings (i.e. does having a higher proportion of one-star ratings make a difference?) 
        ·      Repeat approach of Step 1. with treatment groups selected based on variance of ratings in the 90th percentile

```{r cars}
library(rjson)
library(RCurl)
library(httr)

#Authentication:
require(devtools) #install if necessary (install.packages("devtools")

dev_mode(on=T)

install_github("ThinkToStartR",username="JulianHill")


require(ThinkToStartR)
library(rjson)
require(RCurl)


token <- ThinkToStart("Foursquare_auth",app_name="R_Test",app_id="XXX",app_secret="XXX")


####Get the Data

data <- fromJSON(getURL(paste('https://api.foursquare.com/v2/users/self/venuehistory?oauth_token=',token,'&v=',format(Sys.time(), "%Y%m%d"),sep="")))

response <- data$response
venues <- response$venues$items


no_venues = length(data$response$venues$items)

df = data.frame(no = 1:no_venues)


for (i in 1:nrow(df)){
 
  #Add Name and the location of the Venue
  df$venue_name[i] <- venues[[i]]$venue$name
  df$venue_lat[i] <- venues[[i]]$venue$location$lat
  df$venue_lng[i] <- venues[[i]]$venue$location$lng
  
  ##########################
  #Add the address of the location 
  if(length(venues[[i]]$venue$location$address)>0)
  {
    df$venue_address[i] <- venues[[i]]$venue$location$address
  }
  else{
    df$venue_address[i] <- "No Address Available"
    
  }

  ##########################
  #Add the citiy of the location
  if(length(venues[[i]]$venue$location$city)>0)
  {
    df$venue_city[i] <- venues[[i]]$venue$location$city
  }
  else{
    df$venue_city[i] <- "No City Available"
    
  }
  
  ##########################
  #Add the number of check-ins of the venue
  df$venue_checkinsCount[i] <- venues[[i]]$venue$stats[[1]]
 
  ##########################
  #Add the URL of the URL if defined
 if(length(venues[[i]]$venue$url)>0)
 {
   df$url[i] <- venues[[i]]$venue$url
 }
 else{
   df$url[i] <- NA
   
 }
 
}

 
 mean_lat <- mean(df$venue_lat) # outcome: 50.90956
mean_lon <- mean(df$venue_lng) # outcome: 7.576119

require(rCharts)

map <- Leaflet$new()
map$setView(c(mean_lat, mean_lon), zoom = 5)


for (i in 1:no_venues){
  
  #Get the name and the number of check-ins of the current venue
  name <- df$venue_name[i]
  checkins <- df$venue_checkinsCount[i]
  
  #Add the marker to the map but just add a website link if we have a URL for the venue
  
  #if URL is available
  if(is.na(df$url[i]))
  {  map$marker(c(df$venue_lat[i], df$venue_lng[i]), bindPopup = paste(name,' <br> Checkins: ',checkins,sep=""))
  }
  else
  {
  map$marker(c(df$venue_lat[i], df$venue_lng[i]), bindPopup = paste(name,' <br> Checkins: ',checkins,'<br> <a href="',df$url[i],'" target="_blank">Website</a> ',sep=""))
  }
  
}

map

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
